<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDKit.js Atom and Bond Selector</title>
    <!-- ...other files and HTML tags... -->
    <!-- Load the RDKit JS file -->
    <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Instantiate the WASM module. The inline script below could live elsewhere inside your application code. -->
    <script>
        window
        .initRDKitModule()
        .then(function (RDKit) {
            console.log("RDKit version: " + RDKit.version());
            window.RDKit = RDKit;
            /**
            * The RDKit module is now loaded.
            * You can use it anywhere.
            */
        })
        .catch(() => {
            // handle loading errors here...
        });
    </script>
    <!-- ...your application code goes here... -->
    <style>
        /* Add hover effects for atoms and bonds */
        [class^="bond-"] {
            cursor: pointer;
            transition: fill 0.3s;
        }

        [class^="bond-"]:hover {
            stroke: blue;
        }
    </style>
    <style>
        /* Flex container */
        #flexContainer {
            display: flex;
            align-items: center;
        }

        /* Flex items */
        #flexContainer > * {
            margin-right: 10px;  /* Optional: Add some spacing between items */
        }
    </style>
</head>

<body>
    <div id="flexContainer">
        <input type="text" id="productSmi" placeholder="Enter a product">
        <button onclick="generateReactants()">Generate</button>
        <div id="svgContainer"></div>       
    </div>

    <button onclick="generateInpaintedReactants()">Submit</button>

    <h2>Result:</h2>
    <div id="result"></div>
    
    <script>
        let reactants = ["CC(=O)Oc1ccccc1C(=O)O", "CC(=O)Oc1ccccc1C(=O)O"];
        //let productSmi = "COC1=CC(OC)=C(CCS(=O)(=O)CC2=CC=C(OC)C(O)=C2)C(OC)=C1";
        let productSmi = "[CH3:1][O:2][c:3]1[cH:4][c:5]([O:6][CH3:7])[c:8]([CH2:9][CH2:10][S:11](=[O:12])(=[O:13])[CH2:14][c:15]2[cH:16][cH:17][c:18]([O:19][CH3:20])[c:21]([OH:22])[cH:23]2)[c:24]([O:25][CH3:26])[cH:27]1";
        let generated_reactants = null;
        let bondIndices = [];
        let atomIndices = [];

        function addGlowFilterToSVG(svgElement) {
            // Create the filter definition
            const filter = document.createElementNS("http://www.w3.org/2000/svg", "filter");
            filter.setAttribute("id", "glow");
            filter.setAttribute("x", "-50%");
            filter.setAttribute("y", "-50%");
            filter.setAttribute("width", "200%");
            filter.setAttribute("height", "200%");
        
            const feOffset = document.createElementNS("http://www.w3.org/2000/svg", "feOffset");
            feOffset.setAttribute("result", "offOut");
            feOffset.setAttribute("in", "SourceGraphic");
            feOffset.setAttribute("dx", "0");
            feOffset.setAttribute("dy", "0");
        
            const feColorMatrix = document.createElementNS("http://www.w3.org/2000/svg", "feColorMatrix");
            feColorMatrix.setAttribute("result", "matrixOut");
            feColorMatrix.setAttribute("in", "offOut");
            feColorMatrix.setAttribute("type", "matrix");
            feColorMatrix.setAttribute("values", "0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 1 0");
        
            const feGaussianBlur = document.createElementNS("http://www.w3.org/2000/svg", "feGaussianBlur");
            feGaussianBlur.setAttribute("result", "blurOut");
            feGaussianBlur.setAttribute("in", "matrixOut");
            feGaussianBlur.setAttribute("stdDeviation", "4");
        
            const feBlend = document.createElementNS("http://www.w3.org/2000/svg", "feBlend");
            feBlend.setAttribute("in", "SourceGraphic");
            feBlend.setAttribute("in2", "blurOut");
            feBlend.setAttribute("mode", "normal");
        
            // Append filter elements
            filter.appendChild(feOffset);
            filter.appendChild(feColorMatrix);
            filter.appendChild(feGaussianBlur);
            filter.appendChild(feBlend);
        
            // Create or find the <defs> element in the SVG
            let defs = svgElement.querySelector("defs");
            if (!defs) {
                defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
                svgElement.prepend(defs);
            }
        
            // Append the filter to the defs
            defs.appendChild(filter);
        }
        
        function generateReactants() {
            // var products = document.getElementById('productSmi').value.split(',');
            $.ajax({
                url: '/getReactants',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({productSmi: productSmi}),
                success: function(response) {
                    generated_reactants = response.final_samples;
                    console.log('get_reactants final_samples'+generated_reactants);
                    $('#result').text(response.sampled_reactants_smi.join(' + '));
                    print_results(response.sampled_reactants_smi, response.product_smi);
                }
            });
        }

        function generateInpaintedReactants() {
            $.ajax({
                url: '/getInpaintedReactants',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({productSmi:productSmi, bondIndices: bondIndices, 
                                      generated_reactants:generated_reactants, atomIndices: atomIndices}),
                success: function(response) {
                    generated_reactants = response.final_samples;
                    console.log('inpainted final_samples'+generated_reactants);
                    $('#result').text(response.reactants_smi.join(' + '));
                    print_results(response.reactants_smi, response.product_smi);
                }
            });
        }

        function print_results(sampled_reactants_smi, product_smi) {
            const reactants = sampled_reactants_smi;
            const product = product_smi;
            const stroke_color = 'yellow';
    
            let combinedSVG = '<svg width="800" height="400">';  // Adjust dimensions as needed  
            let xOffset = 0;

            for (let i = 0; i < Math.min(reactants.length, 3); i++) {
                const smiles = reactants[i];
                const mol = RDKit.get_mol(smiles.trim());
                if (mol == null) {
                    continue;
                }
                const molSVG = mol.get_svg(150, 150);  // Adjust dimensions as needed
                // combinedSVG += `<g transform="translate(${xOffset},0)">${molSVG}</g>`;
                // xOffset += 170;  // Adjust based on molecule width + gap
                combinedSVG += `<g transform="translate(${xOffset},0)">${molSVG}</g>`;
                xOffset += 170;  // Adjust based on molecule width + gap
            
                // Add a plus sign if it's not the last reactant
                if (i < reactants.length - 1) {
                    combinedSVG += `<text x="${xOffset}" y="75" font-size="24">+</text>`;
                    xOffset += 30;  // Adjust the spacing for the plus sign
                }
            }
    
            combinedSVG += `<text x="${xOffset}" y="75" font-size="24">â†’</text>`;  // Reaction arrow
            xOffset += 40;
            const mol = RDKit.get_mol(product.trim());
            const molSVG = mol.get_svg(150, 150);  // Adjust dimensions as needed
            combinedSVG += `<g transform="translate(${xOffset},0)">${molSVG}</g>`;
            xOffset += 170;  // Adjust based on molecule width + gap
    
            combinedSVG += '</svg>';
            document.getElementById('svgContainer').innerHTML = combinedSVG;
    
            // Attach event listeners for bonds (same as before)
            document.getElementById('svgContainer').addEventListener('click', function(event) {
                if (event.target.className.baseVal && event.target.className.baseVal.startsWith('bond-')) {
                    const bondElem = document.querySelector(`[class^="${event.target.className.baseVal}"]`);
                    const atomBegElem = document.querySelector(`[class^="atom-${event.target.className.baseVal.split('atom-')[1]}"]`);
                    const atomEndElem = document.querySelector(`[class^="atom-${event.target.className.baseVal.split('atom-')[2]}"]`);
                    
                    bond_idx = parseInt(event.target.className.baseVal.split('bond-')[1].split(' ')[0])
                    atom_beg_idx = parseInt(event.target.className.baseVal.split('atom-')[1])
                    atom_end_idx = parseInt(event.target.className.baseVal.split('atom-')[2])

                    bondIndices.push(bond_idx)
                    atomIndices.push([atom_beg_idx, atom_end_idx])

                    if (bondElem) {
                        bondElem.style.stroke = stroke_color;  // or any color you prefer
                        // handle double bonds: smaller line is nextElementSibling
                        if (bondElem.nextElementSibling && bondElem.nextElementSibling.className.baseVal === event.target.className.baseVal) {
                            bondElem.nextElementSibling.style.stroke = stroke_color;
                        }
                    }

                    if (atomBegElem) { atomBegElem.style.stroke = stroke_color; }
                    if (atomEndElem) { atomEndElem.style.stroke = stroke_color; }
                }
            });
        }
    </script>    
</body>

</html>
